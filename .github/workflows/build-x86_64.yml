name: Build X86_64 OpenWrt

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x86_64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: x86_64-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout self
        uses: actions/checkout@v4

      - name: Free up disk space
        uses: easimon/maximize-build-space@v8
        with:
          root-reserve-mb: 3072
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true

      - name: Install build dependencies
        run: |
          sudo timedatectl set-timezone "$TZ"
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential clang cmake g++ git libncurses5-dev libssl-dev \
            python3 python3-dev python3-pyelftools python3-setuptools rsync subversion unzip wget ccache
          sudo chown $USER:$USER $GITHUB_WORKSPACE

      - name: Clone source code
        run: |
          git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt

      - name: Cache DL and Feeds
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/feeds
          key: ${{ runner.os }}-lede-dl-feeds-${{ hashFiles('feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-lede-dl-feeds-

      - name: Apply custom feeds
        run: |
          [ -e "$FEEDS_CONF" ] && mv "$FEEDS_CONF" openwrt/feeds.conf.default
          chmod +x "$DIY_P1_SH"
          (cd openwrt && "$GITHUB_WORKSPACE/$DIY_P1_SH")

      - name: Update and install feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply custom config and patches
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e "$CONFIG_FILE" ] && mv "$CONFIG_FILE" openwrt/.config
          chmod +x "$DIY_P2_SH"
          (cd openwrt && "$GITHUB_WORKSPACE/$DIY_P2_SH")

      - name: Download sources
        working-directory: openwrt
        run: |
          make defconfig
          make download -j$(($(nproc) * 3 / 2)) || make download -j1

      - name: Compile firmware
        id: compile
        working-directory: openwrt
        run: |
          echo "ðŸ§µ Using $(nproc) threads"
          make -j$(($(nproc) * 3 / 2)) V=s
          echo "status=success" >> "$GITHUB_OUTPUT"
          DEVICE=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
          echo "DEVICE_NAME=${DEVICE:+_$DEVICE}" >> "$GITHUB_ENV"
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> "$GITHUB_ENV"

      - name: Organize firmware
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true'
        run: |
          # Assume x86/64 target
          FIRMWARE_DIR="openwrt/bin/targets/x86/64"
          if [[ ! -d "$FIRMWARE_DIR" ]]; then
            echo "âŒ Firmware directory not found!" >&2
            exit 1
          fi
          rm -rf "$FIRMWARE_DIR/packages"
          echo "FIRMWARE=$GITHUB_WORKSPACE/$FIRMWARE_DIR" >> "$GITHUB_ENV"
          echo "status=success" >> "$GITHUB_OUTPUT"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      # Optional upload steps (cowtransfer, wetransfer, release) remain unchanged
      # - name: Upload to cowtransfer ...
      # - name: Upload to wetransfer ...
      # - name: Create GitHub Release ...

      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: Cleanup old releases (if enabled)
        if: env.UPLOAD_RELEASE == 'true'
        uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}