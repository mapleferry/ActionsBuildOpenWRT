name: Build X86_64 OpenWrt

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x86_64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: x86_64-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 0  # ðŸŒŸ ä¼˜åŒ–ï¼šç¼–è¯‘è¶…æ—¶è®¾ç½®ä¸ºæ— é™åˆ¶ (0)

    steps:
      # 1. ðŸŒŸ ä¼˜åŒ–ï¼šå…ˆæ¸…ç†ç£ç›˜ç©ºé—´ï¼Œé˜²æ­¢ Checkout çš„æ–‡ä»¶è¢«è¯¯åˆ 
      - name: Free up disk space
        uses: easimon/maximize-build-space@v8
        with:
          root-reserve-mb: 3072
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Files (Debug)
        run: |
          echo "Current directory: $PWD"
          ls -la
          if [ -f "diy-part1.sh" ]; then
            echo "âœ… diy-part1.sh found successfully!"
          else
            echo "âŒ diy-part1.sh NOT found!"
            exit 1
          fi

      - name: Set up time zone
        run: sudo timedatectl set-timezone "$TZ"

      # 2. ðŸŒŸ ä¼˜åŒ–ï¼šå¢žå¼ºä¾èµ–å®‰è£…çš„å¯é æ€§
      - name: Install build dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # ç¡®ä¿æƒé™
          sudo chown "$USER":"$USER" "$GITHUB_WORKSPACE"
          
          # 1. ç‹¬ç«‹æ›´æ–°åˆ—è¡¨
          sudo apt update
          
          # 2. å®‰è£…ä¾èµ–
          sudo apt install -y --no-install-recommends \
            build-essential clang cmake g++ git libncurses5-dev libssl-dev \
            python3 python3-dev python3-pyelftools python3-setuptools rsync subversion unzip wget \
            qemu-utils
          
          # 3. æ¸…ç†ç³»ç»Ÿï¼ŒèŠ‚çœç©ºé—´
          sudo apt autoremove --purge -y
          sudo apt clean

      - name: Clone source code
        run: |
          git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt

      - name: Cache DL and Feeds
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/feeds
          key: ${{ runner.os }}-lede-dl-feeds-${{ hashFiles('feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-lede-dl-feeds-

      - name: Apply custom feeds (DIY-Part1)
        working-directory: openwrt
        run: |
          # ä½¿ç”¨ç»å¯¹è·¯å¾„å¼•ç”¨æ ¹ç›®å½•ä¸‹çš„è„šæœ¬
          DIY_P1_SCRIPT="$GITHUB_WORKSPACE/$DIY_P1_SH"
          
          echo "Running script: $DIY_P1_SCRIPT"
          
          # æ£€æŸ¥å¹¶å¤åˆ¶ feeds.conf.default
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" .
            echo "âœ… feeds.conf.default copied."
          fi
          
          # èµ‹äºˆæ‰§è¡Œæƒé™å¹¶è¿è¡Œ
          chmod +x "$DIY_P1_SCRIPT"
          "$DIY_P1_SCRIPT"

      - name: Update and install feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply custom config and patches (DIY-Part2)
        working-directory: openwrt
        run: |
          DIY_P2_SCRIPT="$GITHUB_WORKSPACE/$DIY_P2_SH"
          
          # å¤åˆ¶ files ç›®å½•
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            cp -r "$GITHUB_WORKSPACE/files" ./
            echo "âœ… files directory copied."
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          if [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
            cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
            echo "âœ… .config file copied."
          fi
          
          chmod +x "$DIY_P2_SCRIPT"
          "$DIY_P2_SCRIPT"

      - name: Download sources
        working-directory: openwrt
        run: |
          make defconfig
          make download -j$(($(nproc) + 1)) || make download -j1

      - name: Compile firmware
        id: compile
        working-directory: openwrt
        # ðŸŒŸ ä¼˜åŒ–ï¼šå°†ç¼–è¯‘æ—¥å¿—é‡å®šå‘åˆ°æ–‡ä»¶ï¼Œä¾¿äºŽå¤±è´¥æ—¶æŽ’æŸ¥é—®é¢˜
        run: |
          echo "ðŸ§µ Using $(nproc) threads"
          
          # ç¼–è¯‘å¹¶å°†è¯¦ç»†è¾“å‡ºåŒæ—¶æ‰“å°åˆ°ç»ˆç«¯å’Œ build.log æ–‡ä»¶
          make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
          
          # æ£€æŸ¥ç¼–è¯‘æ˜¯å¦æˆåŠŸ
          if [ $? -ne 0 ]; then
            echo "âŒ Compilation failed. Check build.log artifact."
            echo "status=failure" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          echo "status=success" >> "$GITHUB_OUTPUT"
          DEVICE=$(grep -m1 '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
          echo "DEVICE_NAME=${DEVICE:+_$DEVICE}" >> "$GITHUB_ENV"
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> "$GITHUB_ENV"

      # å…³é”®æ–°å¢žï¼šæ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always() 
        with:
          name: OpenWrt_compile_log
          path: openwrt/build.log
          retention-days: 1 # æ—¥å¿—ä¿ç•™ä¸€å¤©

      # 3. ðŸŒŸ ä¼˜åŒ–ï¼šå®Œå–„ Organize firmware æ­¥éª¤
      - name: Organize firmware
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true'
        run: |
          TARGET_DIR=$(find openwrt/bin/targets -mindepth 2 -maxdepth 2 -type d | head -n1)
          if [ -z "$TARGET_DIR" ] || [ ! -d "$TARGET_DIR" ]; then
            echo "âŒ No firmware target directory found!" >&2
            exit 1
          fi
          
          # ç§»é™¤ç›®æ ‡ç›®å½•ä¸‹çš„ packages
          rm -rf "$TARGET_DIR/packages" 
          # ä¼˜åŒ–æ–°å¢žï¼šç§»é™¤ openwrt æ ¹ç›®å½•ä¸‹çš„ packagesï¼Œå‡å° Artifact ä½“ç§¯
          rm -rf openwrt/bin/packages
          
          echo "FIRMWARE=$GITHUB_WORKSPACE/$TARGET_DIR" >> "$GITHUB_ENV"
          echo "status=success" >> "$GITHUB_OUTPUT"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: Cleanup old releases
        if: env.UPLOAD_RELEASE == 'true'
        uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}