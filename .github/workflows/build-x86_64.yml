name: Build X86_64 OpenWrt

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  
  # é…ç½®å’Œè„šæœ¬è·¯å¾„å˜é‡
  CONFIG_FILE: x86_64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: x86_64-part2.sh
  
  # ðŸŒŸ å…³é”®ï¼šå›ºå®šè„šæœ¬é…ç½®ç›®å½•
  DIY_CONFIG_DIR: diy_config 

  # ä¸Šä¼ å’Œæ—¶åŒºé…ç½®
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # 1. ðŸŒŸ å…³é”®ä¿®å¤ï¼šæ‰‹åŠ¨å…‹éš†å¹¶æ›¿ä»£ actions/checkout
      - name: Manual Clone Self Repo to DIY Config Dir
        run: |
          # å…‹éš†æ‚¨çš„ä»“åº“åˆ° diy_config ç›®å½•
          git clone --depth=1 https://${{ github.token }}@github.com/${{ github.repository }} $DIY_CONFIG_DIR
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "$DIY_CONFIG_DIR/$DIY_P1_SH" ]; then
            echo "âœ… Successfully cloned and verified $DIY_P1_SH in $DIY_CONFIG_DIR."
          else
            echo "âŒ Fatal Error: Manual clone failed. File $DIY_P1_SH not found in $DIY_CONFIG_DIR."
            exit 1
          fi

      - name: Set up time zone
        run: sudo timedatectl set-timezone "$TZ"

      - name: Free up disk space
        uses: easimon/maximize-build-space@v8
        # ... (ä¿æŒä¸å˜)

      - name: Install build dependencies
        # ... (ä¿æŒä¸å˜)

      # 2. å…‹éš† OpenWrt æºç 
      - name: Clone source code
        run: |
          git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt

      - name: Cache DL and Feeds
        # ... (ä¿æŒä¸å˜)

      # 3. åº”ç”¨ DIY-Part1 è„šæœ¬
      - name: Apply custom feeds (DIY-Part1)
        working-directory: openwrt
        run: |
          # å¼•ç”¨å›ºå®šè·¯å¾„
          SCRIPT_ROOT="$GITHUB_WORKSPACE/$DIY_CONFIG_DIR"
          DIY_P1_PATH="$SCRIPT_ROOT/$DIY_P1_SH"
          
          # æ‹·è´ feeds.conf.default æ–‡ä»¶ (å¦‚æžœå­˜åœ¨)
          if [ -f "$SCRIPT_ROOT/feeds.conf.default" ]; then
            cp "$SCRIPT_ROOT/feeds.conf.default" feeds.conf.default
          fi
          
          echo "Executing DIY-Part1 script from: $DIY_P1_PATH"
          chmod +x "$DIY_P1_PATH"
          "$DIY_P1_PATH"

      - name: Update and install feeds
        # ... (ä¿æŒä¸å˜)

      # 4. åº”ç”¨ DIY-Part2 è„šæœ¬
      - name: Apply custom config and patches (DIY-Part2)
        working-directory: openwrt
        run: |
          # å¼•ç”¨å›ºå®šè·¯å¾„
          SCRIPT_ROOT="$GITHUB_WORKSPACE/$DIY_CONFIG_DIR"
          DIY_P2_PATH="$SCRIPT_ROOT/$DIY_P2_SH"
          
          # 1. æ‹·è´è‡ªå®šä¹‰æ–‡ä»¶ (files ç›®å½•)
          if [ -e "$SCRIPT_ROOT/files" ]; then
            cp -r "$SCRIPT_ROOT/files" ./
          fi
          # 2. æ‹·è´ .config æ–‡ä»¶
          if [ -e "$SCRIPT_ROOT/$CONFIG_FILE" ]; then
            cp "$SCRIPT_ROOT/$CONFIG_FILE" .config
          fi
          # 3. æ‰§è¡Œ DIY-Part2 è„šæœ¬
          echo "Executing DIY-Part2 script from: $DIY_P2_PATH"
          chmod +x "$DIY_P2_PATH"
          "$DIY_P2_PATH"
          
      - name: Download sources
        working-directory: openwrt
        run: |
          make defconfig
          # å¥å£®çš„ä¸‹è½½ï¼Œå¸¦é‡è¯•
          make download -j$(($(nproc) + 1)) || make download -j1

      - name: Compile firmware
        id: compile
        working-directory: openwrt
        run: |
          echo "ðŸ§µ Using $(nproc) threads"
          make -j$(($(nproc) + 1)) V=s
          echo "status=success" >> "$GITHUB_OUTPUT"
          DEVICE=$(grep -m1 '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
          echo "DEVICE_NAME=${DEVICE:+_$DEVICE}" >> "$GITHUB_ENV"
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> "$GITHUB_ENV"

      - name: Organize firmware
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true'
        run: |
          # è‡ªåŠ¨æ£€æµ‹ç›®æ ‡è·¯å¾„
          TARGET_DIR=$(find openwrt/bin/targets -mindepth 2 -maxdepth 2 -type d | head -n1)
          if [ -z "$TARGET_DIR" ] || [ ! -d "$TARGET_DIR" ]; then
            echo "âŒ No firmware target directory found!" >&2
            exit 1
          fi
          rm -rf "$TARGET_DIR/packages"
          echo "FIRMWARE=$GITHUB_WORKSPACE/$TARGET_DIR" >> "$GITHUB_ENV"
          echo "status=success" >> "$GITHUB_OUTPUT"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: Cleanup old releases (if enabled)
        if: env.UPLOAD_RELEASE == 'true'
        uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}